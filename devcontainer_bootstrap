#!/bin/bash
# Dev Container Bootstrap Script f√ºr HAminiEMS

# Nicht bei jedem Fehler abbrechen - Fehler werden behandelt
set +e

# Docker-Socket-Fehler unterdr√ºcken (normal in Dev Containers)
export DOCKER_HOST=""
unset DOCKER_HOST 2>/dev/null || true

echo "üöÄ HAminiEMS Dev Container wird initialisiert..."

# Pr√ºfe ob Home Assistant Supervisor l√§uft
if ! command -v ha &> /dev/null; then
    echo "‚ö†Ô∏è  Home Assistant Supervisor CLI nicht gefunden"
    echo "   Das ist normal, wenn der Container au√üerhalb von Home Assistant l√§uft"
else
    echo "‚úÖ Home Assistant Supervisor CLI gefunden"

    # Pr√ºfe ob das Add-On bereits registriert ist
    if ha addons info "local_haminiems" &> /dev/null; then
        echo "‚úÖ Add-On 'local_haminiems' ist bereits registriert"
    else
        echo "üì¶ Registriere Add-On 'local_haminiems'..."
        timeout 30 ha addons reload || echo "‚ö†Ô∏è  Add-On Reload hat zu lange gedauert oder fehlgeschlagen"
        sleep 1
    fi
fi

# Python Dependencies pr√ºfen und installieren
# Suche Python in verschiedenen m√∂glichen Pfaden
PYTHON_CMD=""
if command -v python3 &> /dev/null; then
    PYTHON_CMD="python3"
elif command -v python &> /dev/null && python --version 2>&1 | grep -q "Python 3"; then
    PYTHON_CMD="python"
elif [ -f /usr/bin/python3 ]; then
    PYTHON_CMD="/usr/bin/python3"
elif [ -f /usr/local/bin/python3 ]; then
    PYTHON_CMD="/usr/local/bin/python3"
fi

if [ -n "$PYTHON_CMD" ]; then
    echo "‚úÖ Python 3 gefunden: $($PYTHON_CMD --version 2>&1)"

    # Pr√ºfe ob pip installiert ist
    PIP_CMD=""
    if command -v pip3 &> /dev/null; then
        PIP_CMD="pip3"
    elif command -v pip &> /dev/null; then
        PIP_CMD="pip"
    fi

    if [ -z "$PIP_CMD" ]; then
        echo "üì¶ Installiere pip..."
        if $PYTHON_CMD -m ensurepip --upgrade 2>/dev/null; then
            echo "‚úÖ pip √ºber ensurepip installiert"
            PIP_CMD="$PYTHON_CMD -m pip"
        else
            echo "‚ö†Ô∏è  ensurepip fehlgeschlagen, versuche apt-get/apk..."
            if command -v apt-get &> /dev/null; then
                timeout 60 apt-get update -qq && timeout 120 apt-get install -y python3-pip || echo "‚ö†Ô∏è  apt-get Installation fehlgeschlagen oder zu lange gedauert"
                PIP_CMD="pip3"
            elif command -v apk &> /dev/null; then
                timeout 60 apk add --no-cache py3-pip || echo "‚ö†Ô∏è  apk Installation fehlgeschlagen oder zu lange gedauert"
                PIP_CMD="pip3"
            fi
        fi
    else
        PIP_CMD="pip3"
    fi

    # Upgrade pip (falls pip verf√ºgbar ist)
    if [ -n "$PIP_CMD" ]; then
        echo "üì¶ Aktualisiere pip..."
        timeout 60 $PIP_CMD install --upgrade pip --quiet 2>/dev/null || echo "‚ö†Ô∏è  pip Upgrade fehlgeschlagen oder zu lange gedauert"
    fi

    # Liste der ben√∂tigten Python-Pakete
    REQUIRED_PACKAGES=("flask" "requests" "sqlalchemy")
    MISSING_PACKAGES=()

    # Pr√ºfe welche Pakete fehlen
    for package in "${REQUIRED_PACKAGES[@]}"; do
        if ! $PYTHON_CMD -c "import ${package}" &> /dev/null; then
            MISSING_PACKAGES+=("${package}")
        fi
    done

    # Installiere fehlende Pakete
    if [ ${#MISSING_PACKAGES[@]} -gt 0 ] && [ -n "$PIP_CMD" ]; then
        echo "üì¶ Installiere fehlende Python-Pakete: ${MISSING_PACKAGES[*]}"
        timeout 300 $PIP_CMD install --no-cache-dir "${MISSING_PACKAGES[@]}" || echo "‚ö†Ô∏è  Paket-Installation fehlgeschlagen oder zu lange gedauert"
    elif [ ${#MISSING_PACKAGES[@]} -eq 0 ]; then
        echo "‚úÖ Alle Python-Dependencies sind installiert"
    fi

    # Installiere Entwicklungstools (flake8 f√ºr Linting)
    if [ -n "$PIP_CMD" ] && ! command -v flake8 &> /dev/null; then
        echo "üì¶ Installiere Entwicklungstools (flake8)..."
        timeout 120 $PIP_CMD install --no-cache-dir flake8 --quiet 2>/dev/null || echo "‚ö†Ô∏è  flake8 Installation fehlgeschlagen oder zu lange gedauert"
    fi

    # Pr√ºfe ob alle Pakete jetzt verf√ºgbar sind
    ALL_OK=true
    for package in "${REQUIRED_PACKAGES[@]}"; do
        if ! $PYTHON_CMD -c "import ${package}" &> /dev/null; then
            echo "‚ùå Fehler: ${package} konnte nicht importiert werden"
            ALL_OK=false
        fi
    done

    if [ "$ALL_OK" = true ]; then
        echo "‚úÖ Alle Python-Dependencies sind verf√ºgbar"
    fi
else
    echo "‚ùå Python 3 nicht gefunden - versuche Installation..."
    # Versuche Python zu installieren
    if command -v apt-get &> /dev/null; then
        echo "üì¶ Installiere Python 3 √ºber apt-get..."
        timeout 120 apt-get update -qq && timeout 180 apt-get install -y python3 python3-pip || echo "‚ö†Ô∏è  Python-Installation fehlgeschlagen"
    elif command -v apk &> /dev/null; then
        echo "üì¶ Installiere Python 3 √ºber apk..."
        timeout 120 apk add --no-cache python3 py3-pip || echo "‚ö†Ô∏è  Python-Installation fehlgeschlagen"
    else
        echo "‚ö†Ô∏è  Kein Paketmanager gefunden - Python muss manuell installiert werden"
    fi
    # Nicht mit Fehler beenden, damit Container-Start nicht h√§ngt
fi

# PYTHONPATH setzen (f√ºr lokale Entwicklung)
if [ -n "$WORKSPACE_DIRECTORY" ]; then
    HAMINIEMS_PATH="${WORKSPACE_DIRECTORY}/haminiems/rootfs/usr/bin"
    if [ -d "$HAMINIEMS_PATH" ]; then
        export PYTHONPATH="${HAMINIEMS_PATH}:${PYTHONPATH}"
        echo "‚úÖ PYTHONPATH gesetzt: ${PYTHONPATH}"
    fi
fi

echo ""
echo "‚ú® Dev Container ist bereit!"
echo ""
echo "N√ºtzliche Befehle:"
echo "  - ha addons rebuild local_haminiems  # Add-On neu bauen"
echo "  - ha addons start local_haminiems     # Add-On starten"
echo "  - ha addons logs local_haminiems      # Logs anzeigen"
echo ""

# Immer erfolgreich beenden, auch wenn einige Schritte fehlgeschlagen sind
exit 0


